<?php

use PHPUnit\Framework\TestCase;
define('PHPUNIT_RUNNING', true);
require_once __DIR__ . '/../../Secure/B2/session.php';
require_once __DIR__ . '/../../Model/B2/demande.php';

class RecurrenceTest  extends TestCase{

    private PDO $pdo;
    private RecurrenceModel $modele;

    protected function setUp(): void {
        // ğŸ”¸ Connexion Ã  la base de test MySQL
        $this->pdo = Database::getInstance()->getConnection();
        $this->pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        $this->modele = new RecurrenceModel($this->pdo);

        // ğŸ”¸ Nettoyer les tables utilisÃ©es pour le test
        $this->pdo->exec("DELETE FROM est");
        $this->pdo->exec("DELETE FROM demande");
        $this->pdo->exec("DELETE FROM recurrence");
        
    }

    // Teste si la session dÃ©marre correctement
    public function testSessionStart()
    {
        // Assure-toi que la session est dÃ©marrÃ©e
        if (session_status() == PHP_SESSION_NONE) {
            session_start();
        }

        // VÃ©rifie que la session existe
        $this->assertTrue(session_status() == PHP_SESSION_ACTIVE, "La session n'est pas active.");
    }

    // Teste si le token CSRF est bien gÃ©nÃ©rÃ©
    public function testGenerateCsrfToken()
    {
        // DÃ©marre une session
        if (session_status() == PHP_SESSION_NONE) {
            session_start();
        }
  
        // GÃ©nÃ¨re un token CSRF
        $token = generateCsrfToken();
  
        // VÃ©rifie que le token est bien gÃ©nÃ©rÃ©
        $this->assertNotEmpty($token, "Le token CSRF devrait Ãªtre gÃ©nÃ©rÃ©.");
        $this->assertTrue(strlen($token) > 0, "Le token CSRF ne devrait pas Ãªtre vide.");
    }

    // Teste si le token CSRF est valide
    public function testValidateCsrfToken()
    {
        // DÃ©marre une session
        if (session_status() === PHP_SESSION_NONE) {
            session_start();
        }

        // GÃ©nÃ¨re un token CSRF
        $validToken = generateCsrfToken();

        // Ajoute un token CSRF incorrect pour tester
        $invalidToken = 'invalid-token';

        // Teste un token valide
        $this->assertTrue(validateCsrfToken($validToken), "Le token valide ne devrait pas Ã©chouer.");
        
        // Teste un token invalide
        $this->assertFalse(validateCsrfToken($invalidToken), "Le token invalide ne devrait pas Ãªtre validÃ©.");
    }

    // Teste si la session est protÃ©gÃ©e par le user-agent
    public function testUserAgentSessionProtection()
    {
        // DÃ©marre une session
        if (session_status() === PHP_SESSION_NONE) {
            session_start();
        }
 
        // DÃ©finit un agent utilisateur fictif pour ce test
        $_SERVER['HTTP_USER_AGENT'] = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36';
 
        // Initialise $_SESSION['user_agent']
        $_SESSION['user_agent'] = $_SERVER['HTTP_USER_AGENT'];
 
        // VÃ©rifie que la session a bien l'agent utilisateur
        $this->assertEquals($_SESSION['user_agent'], $_SERVER['HTTP_USER_AGENT'], "L'agent utilisateur dans la session ne correspond pas.");
    }

    public function testAjouterRecurrence(): void {

        // ğŸ”¹ Date actuelle + 1 jour
        $date = new DateTime();
        $date->modify('+1 day');
        $dateStr = $date->format('Y-m-d');
    
        $result = $this->modele->ajouterRecurrence(
            "Test Sujet", "Description de test", $dateStr, 8, null, 2, "mois", null
        );
    
        $this->assertTrue($result['success']);
        $this->assertEquals("RÃ©currence ajoutÃ©e avec succÃ¨s !", $result['message']);
        
    }

    public function testAjouterRecurrenceEtRecuperer(): void {
         // ğŸ”¹ Date actuelle + 1 jour
         $date = new DateTime();
         $date->modify('+1 day');
         $dateStr = $date->format('Y-m-d');

        $result = $this->modele->ajouterRecurrence(
            "Test Sujet 2", "Description de test puis repris", $dateStr,8,null,2,"mois",null
        );

        $this->assertTrue($result['success']);
        $this->assertEquals("RÃ©currence ajoutÃ©e avec succÃ¨s !", $result['message']);

        // VÃ©rifie que les donnÃ©es sont bien insÃ©rÃ©es
        $stmt = $this->pdo->query("SELECT id_recurrence , desc_recurrence FROM recurrence WHERE sujet_reccurrence = 'Test Sujet 2'");
        $data = $stmt->fetch(PDO::FETCH_ASSOC);
        $result = $this->modele->getById($data['id_recurrence']);

        $this->assertNotEmpty($data);
        $this->assertEquals("Description de test puis repris", $data['desc_recurrence']);
    }

    public function testAjouterRecurrenceFreqNull(): void {
        $date = new DateTime();
        $date->modify('+1 day');
        $dateStr = $date->format('Y-m-d');
    
        $result = $this->modele->ajouterRecurrence(
            "Test Sujet Freq Invalide", "Description de test", $dateStr, null, null, 2, "mois", null
        );
    
        $this->assertFalse($result['success']);
        $this->assertEquals("Entrez un nombre pour la frÃ©quence", $result['message']);
    }
    
    public function testAjouterRecurrenceFreqNegative(): void {
        $date = new DateTime();
        $date->modify('+1 day');
        $dateStr = $date->format('Y-m-d');
    
        $result = $this->modele->ajouterRecurrence(
            "Test Sujet Freq Invalide", "Description de test", $dateStr, -5, null, 2, "mois", null
        );
    
        $this->assertFalse($result['success']);
        $this->assertEquals("La frÃ©quence doit Ãªtre un nombre positif", $result['message']);
    }
    
    public function testAjouterRecurrenceSansUnitefrequence(): void {
        $date = new DateTime();
        $date->modify('+1 day');
        $dateStr = $date->format('Y-m-d');
    
        $result = $this->modele->ajouterRecurrence(
            "TestSujet", "Description de test", $dateStr, 8, null, 2, null, "jour"
        );
    
        $this->assertFalse($result['success']);
        $this->assertEquals("UnitÃ© de temps invalide.", $result['message']);
    }
    
    public function testAjouterRecurrenceSansTitre(): void {
        $date = new DateTime();
        $date->modify('+1 day');
        $dateStr = $date->format('Y-m-d');
    
        $result = $this->modele->ajouterRecurrence(
            "", "Description de test", $dateStr, 8, null, 2, "mois", null
        );
    
        $this->assertFalse($result['success']);
        $this->assertEquals("Entrez un titre pour la maintenance", $result['message']);
    }

    public function testAjouterRecurrenceLieuInactif(): void {
        $sujet = 'Test';
        $description = 'Description test';
        $dateAnniv = (new DateTime('+1 day'))->format('Y-m-d');
        $frequence = 5; 
        $rappel = 1;

        // VÃ©rifier si le lieu existe dÃ©jÃ 
        $check = $this->pdo->prepare("SELECT id_lieu FROM lieu WHERE nom_lieu = ? AND id_batiment = ?");
        $check->execute(['LieuInactif Test', 2]);
        $existing = $check->fetch();

        if (!$existing) {
            $stmt = $this->pdo->prepare(" 
                INSERT INTO lieu (nom_lieu, actif_lieu, id_batiment) 
                VALUES (?, ?, ?)
            ");
            $stmt->execute(['LieuInactif Test', 0, 2]);
            $idLieu = $this->pdo->lastInsertId();
        } else {
            $idLieu = $existing['id_lieu'];
        }

        $uniteFrequence = 'jour';
        $uniteRappel = 'jour';


        $result = $this->modele->ajouterRecurrence(
            $sujet,$description,$dateAnniv,$frequence,$rappel,$idLieu,$uniteFrequence,$uniteRappel
        );
    
        $this->assertFalse($result['success']);
        $this->assertEquals("Le lieu sÃ©lectionnÃ© n'est pas valide ou inactif.", $result['message']);
    }
    
    public function testAjouterRecurrenceSansfrequenceRappel(): void {
        $date = new DateTime();
        $date->modify('+1 day');
        $dateStr = $date->format('Y-m-d');
    
        $result = $this->modele->ajouterRecurrence(
            "TestSujet", "Description de test", $dateStr, 8, null, 2, "mois", "jour"
        );
    
        $this->assertTrue($result['success']);
    }
    
    public function testAjouterRecurrenceFrequenceEndessousfrequenceRappel(): void {
        $date = new DateTime();
        $date->modify('+1 day');
        $dateStr = $date->format('Y-m-d');
    
        $result = $this->modele->ajouterRecurrence(
            "TestSujet", "Description de test", $dateStr, 2, 5, 7, "jour", "jour"
        );
    
        $this->assertFalse($result['success']);
        $this->assertEquals("Le dÃ©lai de rappel ne peut Ãªtre supÃ©rieur Ã  la frÃ©quence de la maintenance.", $result['message']);
    }
    
    public function testAjouterRecurrenceSansUniteRappelMaisAvecFrequence(): void {
        $date = new DateTime();
        $date->modify('+1 day');
        $dateStr = $date->format('Y-m-d');
    
        $result = $this->modele->ajouterRecurrence(
            "TestSujet", "Description de test", $dateStr, 2, 8, 2, "mois", null
        );
    
        $this->assertFalse($result['success']);
        $this->assertEquals("Vous ne pouvez pas insÃ©rer une frÃ©quence de rappel si vous n'avez pas sÃ©lectionnÃ© une unitÃ© de rappel", $result['message']);
    }

     public function testAjouterRecurrenceUniteRappelEtDelaiPlusEleveQueFreq(): void {
        $sujet = 'Test';
        $description = 'Description test';
        $dateAnniv = (new DateTime('+1 day'))->format('Y-m-d');
        $frequence = 20; 
        $rappel = 21;
        $idLieu = 1;

        $uniteFrequence = 'jour';
        $uniteRappel = 'mois';


        $result = $this->modele->ajouterRecurrence(
            $sujet,$description,$dateAnniv,$frequence,$rappel,$idLieu,$uniteFrequence,$uniteRappel
        );
    
        $this->assertFalse($result['success']);
        $this->assertEquals("Le dÃ©lai de rappel et l'unitÃ© de rappel ne peuvent Ãªtres supÃ©rieur Ã  la frÃ©quence de la maintenance.", $result['message']);
    }
    
    public function testAjouterRecurrenceDateInvalide(): void {
        $date = new DateTime();
        $date->modify('-1 month');
        $dateStr = $date->format('Y-m-d');
    
        $result = $this->modele->ajouterRecurrence(
            "TestSujet", "Description de test", $dateStr, 2, null, 2, "mois", null
        );
    
        $this->assertFalse($result['success']);
        $this->assertEquals("La date n'est pas valide", $result['message']);
    }

    public function testAjouterRecurrenceRappelNegatif(): void {
        $date = new DateTime();
        $date->modify('+1 month');
        $dateStr = $date->format('Y-m-d');
    
        $result = $this->modele->ajouterRecurrence(
            "TestSujet", "Description de test", $dateStr, 5, -2, 2, "mois", "jour"
        );
    
        $this->assertFalse($result['success']);
        $this->assertEquals("Le dÃ©lai de rappel doit Ãªtre un nombre positif.", $result['message']);
    }

    public function testModifierRecurrence(): void {

        $sujet = 'Test';
        $description = 'Description test';
        $dateAnniv = (new DateTime('+1 day'))->format('Y-m-d');
        $frequence = 5;
        $rappel = null;
        $idLieu = 1;
        $uniteFrequence = 'jour';
        $uniteRappel = null;

        $result = $this->modele->ajouterRecurrence(
            $sujet, $description, $dateAnniv, $frequence, $rappel, $idLieu, $uniteFrequence, $uniteRappel);

        $this->assertTrue($result['success']);

        $stmt = $this->pdo->query("SELECT id_recurrence FROM recurrence WHERE sujet_reccurrence = 'Test Sujet_modif'");
        $idRecurrence = $stmt->fetchColumn(); // On rÃ©cupÃ¨re l'ID

        $sujet = 'Test_sujet_modifie';
        $description = 'Description de test modifiÃ©';
        $dateAnniv = (new DateTime('+5 day'))->format('Y-m-d');
        $frequence = 9; 
        $rappel = null;
        $idLieu = 1;
        $uniteFrequence = 'mois';
        $uniteRappel = null;

        $result = $this->modele->update($idRecurrence,$sujet,$description, $dateAnniv, $frequence, $rappel, $idLieu, $uniteFrequence, $uniteRappel);
        $this->assertTrue($result['success']);

        $this->assertEquals("RÃ©currence mise Ã  jour avec succÃ¨s !", $result['message']);
    }

    public function testModifierRecurrenceEtRecuperer(): void {

        $date = new DateTime();
        $date->modify('+1 day');
        $dateStr = $date->format('Y-m-d');

        $result = $this->modele->ajouterRecurrence(
            "Test Sujet_modif", "Description de test", $dateStr,8,null,2,"mois",null
        );

        $this->assertTrue($result['success']);

        $stmt = $this->pdo->query("SELECT id_recurrence FROM recurrence WHERE sujet_reccurrence = 'Test Sujet_modif'");
        $idRecurrence = $stmt->fetchColumn(); // On rÃ©cupÃ¨re l'ID

        $result = $this->modele->update($idRecurrence,"Test_sujet_modifie","Description de test modifiÃ©",$dateStr,5,2,4,"annÃ©e","mois");
        $this->assertTrue($result['success']);

        $this->assertEquals("RÃ©currence mise Ã  jour avec succÃ¨s !", $result['message']);

        // VÃ©rifie que les donnÃ©es sont bien insÃ©rÃ©es
        $stmt = $this->pdo->query("SELECT id_recurrence , desc_recurrence FROM recurrence WHERE sujet_reccurrence = 'Test_sujet_modifie'");
        $data = $stmt->fetch(PDO::FETCH_ASSOC);
        $result = $this->modele->getById($data['id_recurrence']);

        $this->assertNotEmpty($data);
        $this->assertEquals("Description de test modifiÃ©", $data['desc_recurrence']);
    }

    public function testRecupererRecurrenceSupprime(): void {
         // ğŸ”¹ Date actuelle + 1 jour
         $date = new DateTime();
         $date->modify('+1 day');
         $dateStr = $date->format('Y-m-d');

        $result = $this->modele->ajouterRecurrence(
            "Test Sujet Inex", "Description de test a supprimÃ© puis rÃ©cupÃ©rÃ©", $dateStr,8,null,2,"mois",null
        );

        $this->assertTrue($result['success']);
        $this->assertEquals("RÃ©currence ajoutÃ©e avec succÃ¨s !", $result['message']);

        $stmt = $this->pdo->query("SELECT id_recurrence , desc_recurrence FROM recurrence WHERE desc_recurrence
         = 'Description de test a supprimÃ© puis rÃ©cupÃ©rÃ©'");
        $idRecurrence = $stmt->fetchColumn(); // On rÃ©cupÃ¨re l'ID

        $result = $this->modele->delete($idRecurrence);

        $this->assertTrue($result['success']);

        $stmt = $this->pdo->query("SELECT id_recurrence, desc_recurrence FROM recurrence WHERE desc_recurrence 
        = 'Description de test a supprimÃ© puis rÃ©cupÃ©rÃ©'");
        $data = $stmt->fetch(PDO::FETCH_ASSOC);

        $this->assertNull($result = $this->modele->getById($data['id_recurrence']));
        
    }

    public function testModifierRecurrenceDate(): void {

        $date = new DateTime();
        $date->modify('+1 day');
        $dateStr = $date->format('Y-m-d');

        $result = $this->modele->ajouterRecurrence(
            "Test Sujet_modif", "Description de test", $dateStr,8,null,2,"mois",null
        );

        $this->assertTrue($result['success']);

        $stmt = $this->pdo->query("SELECT id_recurrence FROM recurrence WHERE sujet_reccurrence = 'Test Sujet_modif'");
        $idRecurrence = $stmt->fetchColumn(); // On rÃ©cupÃ¨re l'ID

        
        $date2 = new DateTime();
        $date2->modify('+5 day');
        $dateStr2 = $date2->format('Y-m-d');

        $result = $this->modele->update($idRecurrence,"Test_sujet_modifie_Date","Description de test modifiÃ©",$dateStr2,5,2,4,"annÃ©e","mois");
        $this->assertTrue($result['success']);

          // VÃ©rifie la date
          $stmt = $this->pdo->query("SELECT id_recurrence , date_anniv_recurrence FROM recurrence WHERE sujet_reccurrence = 'Test_sujet_modifie_Date'");
          $data = $stmt->fetch(PDO::FETCH_ASSOC);
          $result = $this->modele->getById($data['id_recurrence']);
  
          $this->assertNotEmpty($data);
          $this->assertEquals($dateStr2, $data['date_anniv_recurrence']);
    }

      public function testModifierRecurrenceLieuInactif(): void {
        $sujet = 'Test';
        $description = 'Description test';
        $dateAnniv = (new DateTime('+1 day'))->format('Y-m-d');
        $frequence = 5; 
        $rappel = 1;
        $idLieu = 1;
        $uniteFrequence = 'jour';
        $uniteRappel = 'jour';

        $result = $this->modele->ajouterRecurrence(
            $sujet,$description,$dateAnniv,$frequence,$rappel,$idLieu,$uniteFrequence,$uniteRappel
        );

        $this->assertTrue($result['success']);

        $stmt = $this->pdo->query("SELECT id_recurrence FROM recurrence WHERE sujet_reccurrence = 'Test Sujet_modif'");
        $idRecurrence = $stmt->fetchColumn(); // On rÃ©cupÃ¨re l'ID

        $sujet = 'Test_sujet_modifie';
        $description = 'Description de test modifiÃ©';
        $dateAnniv = (new DateTime('+2 day'))->format('Y-m-d');
        $frequence = 8; // Valeur invalide
        $rappel = 3;
      
        // VÃ©rifier si le lieu existe dÃ©jÃ 
        $check = $this->pdo->prepare("SELECT id_lieu FROM lieu WHERE nom_lieu = ? AND id_batiment = ?");
        $check->execute(['LieuInactif Test', 2]);
        $existing = $check->fetch();

        if (!$existing) {
            $stmt = $this->pdo->prepare(" 
                INSERT INTO lieu (nom_lieu, actif_lieu, id_batiment) 
                VALUES (?, ?, ?)
            ");
            $stmt->execute(['LieuInactif Test', 0, 2]);
            $idLieu = $this->pdo->lastInsertId();
        } else {
            $idLieu = $existing['id_lieu'];
        }

        $uniteFrequence = null;
        $uniteRappel = 'jour';

        $result = $this->modele->update($idRecurrence,$sujet,$description, $dateAnniv, $frequence, $rappel, $idLieu, $uniteFrequence, $uniteRappel);
        $this->assertFalse($result['success']);
        $this->assertEquals("Le lieu sÃ©lectionnÃ© n'est pas valide ou inactif.", $result['message']);
    }

    public function testModifierRecurrenceFrequenceNegative(): void {

        $date = new DateTime();
        $date->modify('+1 day');
        $dateStr = $date->format('Y-m-d');

        $result = $this->modele->ajouterRecurrence(
            "Test Sujet_modif", "Description de test", $dateStr,8,null,2,"mois",null
        );

        $this->assertTrue($result['success']);

        $stmt = $this->pdo->query("SELECT id_recurrence FROM recurrence WHERE sujet_reccurrence = 'Test Sujet_modif'");
        $idRecurrence = $stmt->fetchColumn(); // On rÃ©cupÃ¨re l'ID

        $result = $this->modele->update($idRecurrence,"Test_sujet_modifie","Description de test modifiÃ©",$dateStr,-5,null,4,"jour",null);
        $this->assertFalse($result['success']);
        $this->assertEquals("La frÃ©quence doit Ãªtre un nombre positif", $result['message']);
    }
    
    public function testModifierRecurrenceUniteFreqInexistent(): void {

        $sujet = 'Test';
        $description = 'Description test';
        $dateAnniv = (new DateTime('+1 day'))->format('Y-m-d');
        $frequence = 5; 
        $rappel = 1;
        $idLieu = 1;
        $uniteFrequence = 'jour';
        $uniteRappel = 'jour';

        $result = $this->modele->ajouterRecurrence(
            $sujet, $description, $dateAnniv, $frequence, $rappel, $idLieu, $uniteFrequence, $uniteRappel);

        $this->assertTrue($result['success']);

        $stmt = $this->pdo->query("SELECT id_recurrence FROM recurrence WHERE sujet_reccurrence = 'Test Sujet_modif'");
        $idRecurrence = $stmt->fetchColumn(); // On rÃ©cupÃ¨re l'ID

        $sujet = 'Test_sujet_modifie';
        $description = 'Description de test modifiÃ©';
        $dateAnniv = (new DateTime('+2 day'))->format('Y-m-d');
        $frequence = 8; 
        $rappel = 3;
        $idLieu = 1;
        $uniteFrequence = null;
        $uniteRappel = 'jour';

        $result = $this->modele->update($idRecurrence,$sujet,$description, $dateAnniv, $frequence, $rappel, $idLieu, $uniteFrequence, $uniteRappel);
        $this->assertFalse($result['success']);
        $this->assertEquals("UnitÃ© de temps invalide.", $result['message']);
    }

    public function testModifierRecurrenceUniteDeInexistent(): void {

        $sujet = 'Test';
        $description = 'Description test';
        $dateAnniv = (new DateTime('+1 day'))->format('Y-m-d');
        $frequence = 5; 
        $rappel = 1;
        $idLieu = 1;
        $uniteFrequence = 'jour';
        $uniteRappel = 'jour';

        $result = $this->modele->ajouterRecurrence(
            $sujet, $description, $dateAnniv, $frequence, $rappel, $idLieu, $uniteFrequence, $uniteRappel);

        $this->assertTrue($result['success']);

        $stmt = $this->pdo->query("SELECT id_recurrence FROM recurrence WHERE sujet_reccurrence = 'Test Sujet_modif'");
        $idRecurrence = $stmt->fetchColumn(); // On rÃ©cupÃ¨re l'ID

        $sujet = 'Test_sujet_modifie';
        $description = 'Description de test modifiÃ©';
        $dateAnniv = (new DateTime('+2 day'))->format('Y-m-d');
        $frequence = 8; 
        $rappel = 3;
        $idLieu = 1;
        $uniteFrequence = 'jour';
        $uniteRappel = null;

        $result = $this->modele->update($idRecurrence,$sujet,$description, $dateAnniv, $frequence, $rappel, $idLieu, $uniteFrequence, $uniteRappel);
        $this->assertFalse($result['success']);
        $this->assertEquals("Vous ne pouvez pas insÃ©rer une frÃ©quence de rappel si vous n'avez pas sÃ©lectionnÃ© une unitÃ© de rappel", $result['message']);
    }

    
     public function testModifierRecurrenceUniteRappelEtDelaiPlusEleveQueFreq(): void {
        
        $sujet = 'Test';
        $description = 'Description test';
        $dateAnniv = (new DateTime('+1 day'))->format('Y-m-d');
        $frequence = 5; 
        $rappel = 1;
        $idLieu = 1;
        $uniteFrequence = 'jour';
        $uniteRappel = 'jour';

        $result = $this->modele->ajouterRecurrence(
            $sujet, $description, $dateAnniv, $frequence, $rappel, $idLieu, $uniteFrequence, $uniteRappel);

        $this->assertTrue($result['success']);

        $stmt = $this->pdo->query("SELECT id_recurrence FROM recurrence WHERE sujet_reccurrence = 'Test Sujet_modif'");
        $idRecurrence = $stmt->fetchColumn(); // On rÃ©cupÃ¨re l'ID

        $sujet = 'Test_sujet_modifie';
        $description = 'Description de test modifiÃ©';
        $dateAnniv = (new DateTime('+2 day'))->format('Y-m-d');
        $frequence = 8; 
        $rappel = 9;
        $idLieu = 1;
        $uniteFrequence = 'jour';
        $uniteRappel = 'mois';

        $result = $this->modele->update($idRecurrence,$sujet,$description, $dateAnniv, $frequence, $rappel, $idLieu, $uniteFrequence, $uniteRappel);
        $this->assertFalse($result['success']);
        $this->assertEquals("Le dÃ©lai de rappel et l'unitÃ© de rappel ne peuvent Ãªtres supÃ©rieur Ã  la frÃ©quence de la maintenance.", $result['message']);
    }
    public function testModifierRecurrenceDateInvalide(): void {

        $sujet = 'Test';
        $description = 'Description test';
        $dateAnniv = (new DateTime('+1 day'))->format('Y-m-d');
        $frequence = 5; 
        $rappel = 1;
        $idLieu = 1;
        $uniteFrequence = 'jour';
        $uniteRappel = 'jour';

        $result = $this->modele->ajouterRecurrence(
            $sujet, $description, $dateAnniv, $frequence, $rappel, $idLieu, $uniteFrequence, $uniteRappel);

        $this->assertTrue($result['success']);

        $stmt = $this->pdo->query("SELECT id_recurrence FROM recurrence WHERE sujet_reccurrence = 'Test Sujet_modif'");
        $idRecurrence = $stmt->fetchColumn(); // On rÃ©cupÃ¨re l'ID

        $sujet = 'Test_sujet_modifie';
        $description = 'Description de test modifiÃ©';
        $dateAnniv = (new DateTime('-5 day'))->format('Y-m-d'); // Valeur invalide
        $frequence = 8; 
        $rappel = 3;
        $idLieu = 1;
        $uniteFrequence = 'jour';
        $uniteRappel = 'jour';

        $result = $this->modele->update($idRecurrence,$sujet,$description, $dateAnniv, $frequence, $rappel, $idLieu, $uniteFrequence, $uniteRappel);
        $this->assertFalse($result['success']);
        $this->assertEquals("La date n'est pas valide", $result['message']);
    }
    public function testModifierRecurrenceRappelPlusGrandFrequen(): void {

        $sujet = 'Test';
        $description = 'Description test';
        $dateAnniv = (new DateTime('+1 day'))->format('Y-m-d');
        $frequence = 5; 
        $rappel = 1;
        $idLieu = 1;
        $uniteFrequence = 'jour';
        $uniteRappel = 'jour';

        $result = $this->modele->ajouterRecurrence(
            $sujet, $description, $dateAnniv, $frequence, $rappel, $idLieu, $uniteFrequence, $uniteRappel);

        $this->assertTrue($result['success']);

        $stmt = $this->pdo->query("SELECT id_recurrence FROM recurrence WHERE sujet_reccurrence = 'Test Sujet_modif'");
        $idRecurrence = $stmt->fetchColumn(); // On rÃ©cupÃ¨re l'ID

        $sujet = 'Test_sujet_modifie';
        $description = 'Description de test modifiÃ©';
        $dateAnniv = (new DateTime('+2 day'))->format('Y-m-d');
        $frequence = 8; 
        $rappel = 9;
        $idLieu = 1;
        $uniteFrequence = 'jour';
        $uniteRappel = 'jour';

        $result = $this->modele->update($idRecurrence,$sujet,$description, $dateAnniv, $frequence, $rappel, $idLieu, $uniteFrequence, $uniteRappel);
        $this->assertFalse($result['success']);
        $this->assertEquals("Le dÃ©lai de rappel ne peut Ãªtre supÃ©rieur Ã  la frÃ©quence de la maintenance.", $result['message']);
    }
    public function testModifierRecurrenceDelaiRappelNegatif(): void {

        $sujet = 'Test';
        $description = 'Description test';
        $dateAnniv = (new DateTime('+1 day'))->format('Y-m-d');
        $frequence = 5;
        $rappel = 1;
        $idLieu = 1;
        $uniteFrequence = 'jour';
        $uniteRappel = 'jour';

        $result = $this->modele->ajouterRecurrence(
            $sujet, $description, $dateAnniv, $frequence, $rappel, $idLieu, $uniteFrequence, $uniteRappel);

        $this->assertTrue($result['success']);

        $stmt = $this->pdo->query("SELECT id_recurrence FROM recurrence WHERE sujet_reccurrence = 'Test Sujet_modif'");
        $idRecurrence = $stmt->fetchColumn(); // On rÃ©cupÃ¨re l'ID

        $sujet = 'Test_sujet_modifie';
        $description = 'Description de test modifiÃ©';
        $dateAnniv = (new DateTime('+2 day'))->format('Y-m-d');
        $frequence = 8; 
        $rappel = -5; // Valeur invalide
        $idLieu = 1;
        $uniteFrequence = 'jour';
        $uniteRappel = null;

        $result = $this->modele->update($idRecurrence,$sujet,$description, $dateAnniv, $frequence, $rappel, $idLieu, $uniteFrequence, $uniteRappel);
        $this->assertFalse($result['success']);
        $this->assertEquals("Le dÃ©lai de rappel doit Ãªtre un nombre positif ou alors 0 si vous ne voulez pas de rappel.", $result['message']);
    }

    public function testSupprimerRecurrence(): void {
        $date = new DateTime();
        $date->modify('+1 day');
        $dateStr = $date->format('Y-m-d');

        $result = $this->modele->ajouterRecurrence(
            "Test Sujet supp", "Description de test", $dateStr,8,null,2,"mois",null
        );

        $this->assertTrue($result['success']);

        $stmt = $this->pdo->query("SELECT id_recurrence FROM recurrence WHERE sujet_reccurrence = 'Test Sujet supp'");
        $idRecurrence = $stmt->fetchColumn(); // On rÃ©cupÃ¨re l'ID

        $result = $this->modele->delete($idRecurrence);

        $this->assertTrue($result['success']);
    }
    
    public function testSupprimerRecurrenceInexistente(): void {

        $stmt = $this->pdo->query("SELECT id_recurrence FROM recurrence WHERE sujet_reccurrence = 'Test Sujet supp'");
        $idRecurrence = $stmt->fetchColumn(); // On rÃ©cupÃ¨re l'ID d'une maintenance qui n'existe pas

        $result = $this->modele->delete($idRecurrence);

        $this->assertfalse($result['success']);
        $this->assertEquals("ID de la rÃ©currence est vide.", $result['message']);
    }

    
    public function testDatabaseUsed(): void {
        $stmt = $this->pdo->query("SELECT DATABASE()");
        $dbName = $stmt->fetchColumn();
        $this->assertEquals("albatros_test", $dbName);
    }

    public function testDatabasefalse(): void {
        $this->expectException(PDOException::class); 
        // Cette table n'existe pas, donc Ã§a dÃ©clenche bien une exception
        $this->pdo->query("SELECT * FROM table_qui_pas");
    }

    public function testInvalidDatabaseConnection(): void {
        $this->expectException(PDOException::class);
    
        new PDO("mysql:host=localhost;dbname=bd_invalide", "root", ""); // mauvaise base
    }

}
?>